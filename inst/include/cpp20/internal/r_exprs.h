#ifndef CPP20_R_EXPRS_H
#define CPP20_R_EXPRS_H

#include <cpp20/internal/r_coerce.h>
#include <cpp20/internal/r_make_vec.h>

namespace cpp20 {

inline r_sexp eval(const r_sexp& expr, const r_sexp& env){
  return r_sexp(cpp11::safe[Rf_eval](expr, env));
}

namespace internal {

template<typename... Args>
inline r_sexp make_pairlist(Args... args) {
  constexpr int n = sizeof...(args);

  if constexpr (n == 0){
    return r_sexp(Rf_allocList(0));
  } else {
    r_sexp out = r_sexp(cpp11::safe[Rf_allocList](n));

    SEXP current = out;

    (([&]() {
      if constexpr (is<Args, arg>) {
        SETCAR(current, as<r_sexp>(args.value));
        SET_TAG(current, as<r_sym>(args.name));
      } else {
        SETCAR(current, as<r_sexp>(args));
      }
      current = CDR(current);
    }()), ...);

    return out;
  }
}


template<typename... Args>
inline r_sexp make_expr(Args... args) { 

  r_sexp pairlist = make_pairlist(args...);
  return r_sexp(Rf_lcons(r_null, pairlist));
}

}

}

#endif
